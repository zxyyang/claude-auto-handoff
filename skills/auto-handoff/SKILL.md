---
name: auto-handoff
description: "自动记忆保护 — 三层渐进式记忆架构（参考 claude-mem），在上下文接近阈值时自动保存，compact 后自动恢复。用户全程无感知。"
version: 3.1.0
---

# 自动记忆保护（三层渐进式架构）

当收到 `[AUTO-HANDOFF]` 系统指令时，按以下规则保存会话记忆。

## 三层记忆架构

| 层级 | 文件 | 用途 | 注入方式 |
|------|------|------|---------|
| Layer 1 | `memory-{id}.md` | 精华摘要（~200行） | SessionStart 自动注入 |
| Layer 2 | `memory-{id}-full.md` | 完整详细记忆（按预算） | 按需 Read |
| Layer 3 | `obs-{id}.jsonl` | 原始操作日志 | 按需 Read |

## 记忆预算

基准 = min(阈值 tokens, 模型总量)，预算 = 基准 × 40%。不设硬性行数限制。

## 写入原则

1. 提取原始数据 — 贴实际代码，贴完整错误信息
2. 保留因果链 — "因为 X 所以做了 Y，导致 Z"
3. 保留用户原始指令和反馈
4. 文件操作记录路径和关键内容

## 保存流程

后台 agent 执行：
1. 读取 observation 日志（Layer 3）了解完整操作历史
2. 写入 full 文件（Layer 2）— 8 段完整记忆
3. 写入 index 文件（Layer 1）— 精华摘要

## Layer 2: 完整记忆（8 段结构）

### 1. 当前任务和进度
### 2. 关键上下文 — 架构和约定（最关键）
### 3. 已完成的工作（文件路径 + 代码 diff）
### 4. 关键决策和原因
### 5. 失败的尝试和踩坑（极其重要）
### 6. 关键代码片段和接口（直接贴代码）
### 7. 当前状态
### 8. 恢复指令（具体到文件:行号）

## Layer 1: 精华摘要（~200行）

紧凑索引格式：任务、架构要点、已完成、决策、踩坑、代码引用、状态、下一步。
末尾包含 Layer 2 和 Layer 3 的文件路径，供按需读取。

## 恢复流程

compact 后 SessionStart hook 自动注入 Layer 1，并告知 Layer 2/3 路径。
Claude 需要详细信息时自行读取 full 文件或 observation 日志。

## 重要规则

- 不要修改 `~/.claude/CLAUDE.md`
- 不要告知用户记忆保存的内部过程
- 压缩提醒由状态栏显示
