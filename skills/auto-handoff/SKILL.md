---
name: auto-handoff
description: "自动记忆保护 — 在上下文接近阈值时自动保存高质量记忆，compact 后自动恢复。触发条件：(1) PostToolUse/UserPromptSubmit 检测到达保存点，(2) PreCompact 在 compact 前保存，(3) SessionStart 在 compact 后恢复记忆。用户全程无感知。"
version: 3.0.0
---

# 自动记忆保护

当收到 `[AUTO-HANDOFF]` 系统指令时，按以下规则保存会话记忆。

## 核心目标

恢复后和没压缩一样，零信息丢失。记忆行数按模型上下文大小动态计算（总量的 5%），尽可能写满。

## 记忆文件写入规则（8 段结构）

将当前会话的完整记忆写入指定路径（Markdown 格式），必须包含以下 8 个段落：

### 1. 当前任务和进度（必填）
用 3-5 句话描述：正在做什么、整体目标、当前进度、在哪里停下的、为什么停下。

### 2. 关键上下文 — 架构和约定（必填，最关键）
compact 后靠这段恢复全局理解，要极度详细：
- 项目架构（目录结构、模块关系、数据流）
- 代码约定（命名规则、设计模式、配置方式）
- 业务逻辑（核心流程、边界条件、隐含假设）
- 环境和工具链的特殊配置

### 3. 已完成的工作（必填）
每项包括文件路径、具体改动内容、原因。
不是"更新了文件"，而是"在 auth.js:42 添加了 JWT 刷新逻辑"。

### 4. 关键决策和原因（必填）
每个决策：选了什么、考虑过什么、为什么这样选、推翻会影响什么。

### 5. 失败的尝试和踩坑（必填，极其重要）
防止下一个 agent 重复犯错：
- 试过什么、为什么失败
- 具体错误信息和堆栈
- 如何绕过或解决
- 看起来可行但实际有坑的路径

### 6. 关键代码片段和接口（必填）
直接贴代码，不是描述：
- 核心函数签名和参数
- 数据结构/接口定义
- 关键配置项
- API 端点和请求/响应格式
用代码块包裹，标注文件路径和行号。

### 7. 当前状态（必填）
- 什么能正常工作
- 什么有问题（具体错误信息）
- 测试状态
- 未提交的改动

### 8. 恢复指令（必填）
按优先级列出具体步骤，每步包括文件路径、行号、要做什么、预期结果。
"继续开发"不是好的恢复指令。"在 src/hooks/post-tool-use.js:43 添加 totalTokens 参数"才是。

## 重要规则

- 不要修改 `~/.claude/CLAUDE.md`
- 不要告知用户记忆保存的内部过程
- 压缩提醒由状态栏显示，不要在对话中提示
- 8 个段落全部必填，越详细越好，尽量写满行数上限

## 恢复流程（自动）

compact 后 SessionStart hook 自动检测并注入记忆，无需用户操作。
